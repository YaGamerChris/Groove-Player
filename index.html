<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Estamos a mitad de camino 1.5 Beta!</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<style>
  :root {
    --bg-color: #111;
    --text-color: #fff;
    --accent-color: #FFFF;
    --bg-secondary: #222;
  }
  body.light {
    --bg-color: #f0f0f0;
    --text-color: #000;
    --accent-color: #007aff;
    --bg-secondary: #e0e0e0;
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, var(--bg-color), var(--bg-secondary));
    color: var(--text-color);
    height: 100vh;
    display: flex;
    overflow: hidden;
    transition: background 1.5s ease, color 0.5s ease;
    position: relative;
  }
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.3;
    filter: blur(30px);
    z-index: -1;
    pointer-events: none;
    transition: background-image 1.5s ease-in-out;
  }
  body.has-cover::before {
    background-image: var(--song-bg);
  }
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 20px;
    user-select: none;
    opacity: 0;
    transition: opacity 1s ease;
  }
  .main.visible {
    opacity: 1;
    animation: fadeIn 1s ease forwards;
  }
  .now-playing {
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: fadeIn 1s ease forwards;
    position: relative;
    width: 320px;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
  }
  .cover {
    width: 280px;
    height: 280px;
    background: #444;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    margin-bottom: 20px;
    box-shadow: 0 0 25px var(--accent-color);
    transition: background-image 1.5s ease-in-out, box-shadow 1.5s ease-in-out, transform 0.6s ease;
  }
  .cover.playing {
    animation: zoomInOut 3s ease infinite;
  }
  @keyframes zoomInOut {
    0%, 100% {transform: scale(1);}
    50% {transform: scale(1.05);}
  }
  .track-title {
    font-size: 26px;
    font-weight: bold;
    margin-bottom: 5px;
    text-align: center;
    text-shadow: 0 0 10px var(--accent-color);
    transition: color 0.5s;
  }
  .track-artist {
    font-size: 16px;
    color: #aaa;
    margin-bottom: 15px;
    text-align: center;
    text-shadow: 0 0 6px var(--accent-color);
    transition: color 0.5s;
  }
  .controls {
    display: flex;
    gap: 40px;
    margin-bottom: 20px;
  }
  .controls button {
    font-size: 30px;
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    transition: transform 0.3s ease, color 0.3s ease;
    user-select: none;
  }
  .controls button:hover {
    color: var(--accent-color);
  }
  .controls button:active {
    transform: scale(1.2);
  }
  .progress {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    max-width: 450px;
  }
  .progress-bar {
    flex: 1;
    height: 6px;
    background: #555;
    position: relative;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.3s;
  }
  .progress-bar:hover {
    background: var(--accent-color);
  }
  .progress-fill {
    height: 100%;
    background: var(--accent-color);
    width: 0%;
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: space-between;
    padding: 8px 20px;
    font-size: 14px;
    background: transparent;
    color: var(--text-color);
    opacity: 0.5;
    pointer-events: none;
    z-index: 9999;
    user-select: none;
  }
  /* Indicador reproducción en 2do plano */
  body.background-playing .now-playing::after {
    content: "Reproduciendo en segundo plano";
    position: fixed;
    bottom: 50px;
    right: 20px;
    background: var(--accent-color);
    color: var(--bg-color);
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    box-shadow: 0 0 10px var(--accent-color);
    user-select: none;
    opacity: 0.8;
    animation: fadeInSlide 1s forwards;
  }
  @keyframes fadeInSlide {
    from {opacity: 0; transform: translateY(20px);}
    to {opacity: 0.8; transform: translateY(0);}
  }
  /* Pantalla de carga */
  #loadingScreen {
    position: fixed;
    inset: 0;
    background: var(--bg-color);
    color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    z-index: 10000;
    user-select: none;
  }
  /* Spinner */
  .spinner {
    border: 5px solid rgba(255, 255, 255, 0.2);
    border-top: 5px solid var(--accent-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    margin-right: 15px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  </style>
</head>
<body>

</style>
</head>
<body>
  <div id="loadingScreen">
    <div class="spinner"></div>
    Almacenando de Bufer...
  </div>
      </div>
  <div class="main">
    <div class="now-playing active" id="nowPlaying">
      <div class="cover" id="cover"></div>
      <div class="track-title" id="title">Sin canción</div>
      <div class="track-artist" id="artist">Unknown</div>

      <div class="controls">
        <button id="prev" title="Anterior">⏮️</button>
        <button id="play" title="Reproducir/Pausar">▶️</button>
        <button id="next" title="Siguiente">⏭️</button>
        <button id="repeat" title="Repetir">OFF</button>
      </div>

      <div class="progress">
        <span id="currentTime">0:00</span>
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span id="duration">0:00</span>
      </div>

      <input type="file" id="folderInput" webkitdirectory multiple style="margin-top:20px;"/>
    </div>
    <audio id="player"></audio>
  </div>
  <footer>
    <div>Versión 1.5</div>
    <div>© Esta página está protegida por derechos de autor.</div>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script>
  const player = document.getElementById('player');
  const cover = document.getElementById('cover');
  const title = document.getElementById('title');
  const artist = document.getElementById('artist');
  const playBtn = document.getElementById('play');
  const nextBtn = document.getElementById('next');
  const prevBtn = document.getElementById('prev');
  const repeatBtn = document.getElementById('repeat');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const folderInput = document.getElementById('folderInput');

  let playlist = [];
  let currentIndex = 0;
  let isPlaying = false;
  let repeatMode = 'off'; // 'off', 'all', 'one'

  // Detectar si pestaña está activa
  let isTabActive = true;
  document.addEventListener('visibilitychange', () => {
    isTabActive = !document.hidden;
    updateBackgroundPlayingIndicator();
  });

  function updateBackgroundPlayingIndicator() {
    if (!isTabActive && isPlaying) {
      document.body.classList.add('background-playing');
    } else {
      document.body.classList.remove('background-playing');
    }
  }

  function formatTime(time) {
    const min = Math.floor(time / 60);
    const sec = Math.floor(time % 60);
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
  }

  // Extraer color predominante simple (promedio RGB)
  function averageColor(image) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width = image.width;
    const height = canvas.height = image.height;
    ctx.drawImage(image, 0, 0, width, height);
    const data = ctx.getImageData(0, 0, width, height).data;
    let r=0, g=0, b=0, count=0;
    for (let i=0; i<data.length; i+=4*10) {
      r += data[i];
      g += data[i+1];
      b += data[i+2];
      count++;
    }
    r = Math.floor(r/count);
    g = Math.floor(g/count);
    b = Math.floor(b/count);
    return {r, g, b};
  }

  function rgbToCss({r, g, b}) {
    return `rgb(${r},${g},${b})`;
  }

  function setDynamicBackground(imageSrc) {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      const avg = averageColor(img);
      const c1 = rgbToCss(avg);
      const c2 = `rgba(0,0,0,0.85)`;
      document.body.style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
      document.body.classList.add('has-cover');
      document.body.style.setProperty('--song-bg', `url(${imageSrc})`);
    };
    img.src = imageSrc;
  }

  function loadTrack(index) {
    const file = playlist[index];
    const url = URL.createObjectURL(file);
    player.src = url;

    title.textContent = file.name;
    artist.textContent = "Desconocido";
    cover.style.backgroundImage = 'url("https://via.placeholder.com/280x280?text=Sin+Portada")';
    cover.classList.remove('playing');

    jsmediatags.read(file, {
      onSuccess: function(tag) {
        const pic = tag.tags.picture;
        if (pic) {
          let base64 = "";
          for (let i = 0; i < pic.data.length; i++) {
            base64 += String.fromCharCode(pic.data[i]);
          }
          const imageUri = `data:${pic.format};base64,${btoa(base64)}`;
          cover.style.backgroundImage = `url(${imageUri})`;
          setDynamicBackground(imageUri);
        } else {
          document.body.style.background = `linear-gradient(135deg, var(--bg-color), var(--bg-secondary))`;
          document.body.classList.remove('has-cover');
        }
        if (tag.tags.artist) artist.textContent = tag.tags.artist;
        if (tag.tags.title) title.textContent = tag.tags.title;
      },
      onError: function() {
        document.body.style.background = `linear-gradient(135deg, var(--bg-color), var(--bg-secondary))`;
        document.body.classList.remove('has-cover');
      }
    });
    highlightTrack();
    fadeNowPlaying();
  }

  function playTrack() {
    player.play();
    isPlaying = true;
    playBtn.textContent = '⏸️';
    cover.classList.add('playing');
    updateBackgroundPlayingIndicator();
    updateMediaSessionMetadata();
  }

  function pauseTrack() {
    player.pause();
    isPlaying = false;
    playBtn.textContent = '▶️';
    cover.classList.remove('playing');
    updateBackgroundPlayingIndicator();
    updateMediaSessionMetadata();
  }

  function highlightTrack() {
    // Puedes implementar destacar canción si haces lista visual después
  }

  function updateMediaSessionMetadata() {
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: title.textContent,
        artist: artist.textContent,
        artwork: [
          { src: cover.style.backgroundImage.slice(5, -2), sizes: '280x280', type: 'image/png' }
        ]
      });
      navigator.mediaSession.playbackState = isPlaying ? "playing" : "paused";

      navigator.mediaSession.setActionHandler('play', playTrack);
      navigator.mediaSession.setActionHandler('pause', pauseTrack);
      navigator.mediaSession.setActionHandler('previoustrack', () => {
        if (currentIndex > 0) {
          currentIndex--;
          loadTrack(currentIndex);
          playTrack();
        }
      });
      navigator.mediaSession.setActionHandler('nexttrack', () => {
        if (currentIndex + 1 < playlist.length) {
          currentIndex++;
          loadTrack(currentIndex);
          playTrack();
        }
      });
    }
  }

  function fadeNowPlaying() {
    const nowPlaying = document.getElementById('nowPlaying');
    nowPlaying.style.animation = 'none';
    void nowPlaying.offsetWidth;
    nowPlaying.style.animation = 'fadeIn 1s ease forwards';
  }

  playBtn.addEventListener('click', () => {
    if (isPlaying) pauseTrack();
    else playTrack();
  });

  nextBtn.addEventListener('click', () => {
    if (currentIndex + 1 < playlist.length) {
      currentIndex++;
      loadTrack(currentIndex);
      playTrack();
    }
  });

  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      loadTrack(currentIndex);
      playTrack();
    }
  });

  // Repetición con iconos dinámicos
  repeatBtn.addEventListener('click', () => {
    if (repeatMode === 'off') {
      repeatMode = 'all';
      repeatBtn.textContent = '🔁';       // Repetir toda la lista
      repeatBtn.style.color = 'var(--accent-color)';
      repeatBtn.title = 'Repetir toda la lista';
    } else if (repeatMode === 'all') {
      repeatMode = 'one';
      repeatBtn.textContent = '🔂';       // Repetir canción actual
      repeatBtn.style.color = 'var(--accent-color)';
      repeatBtn.title = 'Repetir canción actual';
    } else {
      repeatMode = 'off';
      repeatBtn.textContent = 'OFF';       // Repetir apagado
      repeatBtn.style.color = 'var(--text-color)';
      repeatBtn.title = 'Repetir apagado';
    }
  });

  player.addEventListener('ended', () => {
    switch (repeatMode) {
      case 'one':
        player.currentTime = 0;
        playTrack();
        break;
      case 'all':
        currentIndex = (currentIndex + 1) % playlist.length;
        loadTrack(currentIndex);
        playTrack();
        break;
      case 'off':
        if (currentIndex + 1 < playlist.length) {
          currentIndex++;
          loadTrack(currentIndex);
          playTrack();
        } else {
          pauseTrack();
        }
        break;
    }
  });

  player.addEventListener('timeupdate', () => {
    if (!isNaN(player.duration)) {
      const percent = (player.currentTime / player.duration) * 100;
      progressFill.style.width = percent + '%';
      currentTimeEl.textContent = formatTime(player.currentTime);
      durationEl.textContent = formatTime(player.duration);
    }
  });

  progressBar.addEventListener('click', e => {
    const rect = progressBar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    player.currentTime = percent * player.duration;
  });

  folderInput.addEventListener('change', () => {
    playlist = Array.from(folderInput.files).filter(f => f.type.startsWith('audio/'));
    playlist.sort((a, b) => a.name.localeCompare(b.name));
    if (playlist.length) {
      currentIndex = 0;
      loadTrack(0);
      playTrack();
    }
  });

  function hideLoadingScreen() {
    const loading = document.getElementById('loadingScreen');
    const main = document.querySelector('.main');
    if (loading) {
      loading.style.display = 'none';
    }
    if (main) {
      main.classList.add('visible');
    }
  }

  window.addEventListener('load', () => {
    setTimeout(hideLoadingScreen, 5000);
  });

  // Inicializar botón repetición en OFF al cargar
  function initRepeatBtn() {
    repeatBtn.textContent = 'OFF';
    repeatBtn.style.color = 'var(--text-color)';
    repeatBtn.title = 'Repetir apagado';
  }
  initRepeatBtn();

</script>
</body>
</html>
